const carMarket = {
  sellers: [
    {
      agencyName: "Best Deal",
      cash: 1245000,
      credit: 200000,
      agencyId: "Plyq5M5AZ",

      cars: [
        {
          brand: "bmw",
          models: [
            {
              name: "3",
              year: 2015,
              price: 137000,
              carNumber: "AZJZ4",
              ownerId: "Plyq5M5AZ",
            },
            {
              name: "X6",
              year: 2020,
              price: 966500,
              carNumber: "S6DL1",
              ownerId: "Plyq5M5AZ",
            },
          ],
        },
        {
          brand: "toyota",
          models: [
            {
              name: "Land Cruiser",
              year: 2020,
              price: 336300,
              carNumber: "6rvXw",
              ownerId: "Plyq5M5AZ",
            },
            {
              name: "Hilux",
              year: 2005,
              price: 35005,
              carNumber: "MWXBG",
              ownerId: "Plyq5M5AZ",
            },
            {
              name: "Corolla",
              year: 2020,
              price: 111900,
              carNumber: "hCzl-",
              ownerId: "Plyq5M5AZ",
            },
          ],
        },
        {
          brand: "Ford",
          models: [
            {
              name: "Focus",
              year: 2020,
              price: 98200,
              carNumber: "kN3HP",
              ownerId: "Plyq5M5AZ",
            },
            {
              name: "Focus",
              year: 2005,
              price: 6502,
              carNumber: "LJTCs",
              ownerId: "Plyq5M5AZ",
            },
          ],
        },
        {
          brand: "Alpha romeo",
          models: [
            {
              name: "Romeo Julia",
              year: 2020,
              price: 275406,
              carNumber: "2kjy7",
              ownerId: "Plyq5M5AZ",
            },
            {
              name: "Romeo Stelvio",
              year: 2019,
              price: 215403,
              carNumber: "7A5b-",
              ownerId: "Plyq5M5AZ",
            },
          ],
        },
        {
          brand: "Chevrolet",
          models: [
            {
              name: "Traverse",
              year: 2020,
              price: 201102,
              carNumber: "QwBOT",
              ownerId: "Plyq5M5AZ",
            },
            {
              name: "Impala",
              year: 2019,
              price: 165041,
              carNumber: "2v4jt",
              ownerId: "Plyq5M5AZ",
            },
            {
              name: "Malibu",
              year: 2017,
              price: 75405,
              carNumber: "O4_Jv",
              ownerId: "Plyq5M5AZ",
            },
          ],
        },
      ],
    },
    {
      agencyName: "CarMax",
      cash: 968541,
      credit: 500000,
      agencyId: "26_IPfHU1",
      cars: [
        {
          brand: "bmw",
          models: [
            {
              name: "X5",
              year: 2015,
              price: 218000,
              carNumber: "4Ixb0",
              ownerId: "26_IPfHU1",
            },
            {
              name: "X6",
              year: 2014,
              price: 97100,
              carNumber: "kAnv-",
              ownerId: "26_IPfHU1",
            },
            {
              name: "Z4",
              year: 2019,
              price: 296900,
              carNumber: "ISMdU",
              ownerId: "26_IPfHU1",
            },
            {
              name: "3",
              year: 2010,
              price: 75100,
              carNumber: "9DJPw",
              ownerId: "26_IPfHU1",
            },
          ],
        },
        {
          brand: "toyota",
          models: [
            {
              name: "Land Cruiser",
              year: 2005,
              price: 80540,
              carNumber: "Kt-pW",
              ownerId: "26_IPfHU1",
            },
            {
              name: "Corolla",
              year: 2019,
              price: 109100,
              carNumber: "YiYdI",
              ownerId: "26_IPfHU1",
            },
            {
              name: "Hilux",
              year: 2019,
              price: 204000,
              carNumber: "DRmNw",
              ownerId: "26_IPfHU1",
            },
          ],
        },
        {
          brand: "Ford",
          models: [
            {
              name: "F250",
              year: 2020,
              price: 198500,
              carNumber: "g4Wfp",
              ownerId: "26_IPfHU1",
            },
            {
              name: "Explorer",
              year: 2020,
              price: 265200,
              carNumber: "iNT8Q",
              ownerId: "26_IPfHU1",
            },
          ],
        },
        {
          brand: "Alpha romeo",
          models: [
            {
              name: "Spider",
              year: 2011,
              price: 75405,
              carNumber: "6t7QU",
              ownerId: "26_IPfHU1",
            },
            {
              name: "166",
              year: 2002,
              price: 12400,
              carNumber: "XMqpn",
              ownerId: "26_IPfHU1",
            },
          ],
        },
        {
          brand: "Chevrolet",
          models: [
            {
              name: "Impala",
              year: 2016,
              price: 65042,
              carNumber: "vbeAo",
              ownerId: "26_IPfHU1",
            },
            {
              name: "Savannah",
              year: 2016,
              price: 76505,
              carNumber: "WelWa",
              ownerId: "26_IPfHU1",
            },
          ],
        },
      ],
    },
    {
      agencyName: "The Auto World",
      cash: 687450,
      credit: 200000,
      agencyId: "gNHjNFL12",
      cars: [
        {
          brand: "bmw",
          models: [
            {
              name: "X6",
              year: 2018,
              price: 548100,
              carNumber: "EMW_7",
              ownerId: "gNHjNFL12",
            },
            {
              name: "3",
              year: 2017,
              price: 178000,
              carNumber: "XlnB4",
              ownerId: "gNHjNFL12",
            },
          ],
        },
        {
          brand: "toyota",
          models: [
            {
              name: "Prius",
              year: 2017,
              price: 101542,
              carNumber: "-RQgN",
              ownerId: "gNHjNFL12",
            },
            {
              name: "Highlander",
              year: 2017,
              price: 202540,
              carNumber: "AZJZ4",
              ownerId: "gNHjNFL12",
            },
            {
              name: "Corolla",
              year: 1996,
              price: 5420,
              carNumber: "kHE8f",
              ownerId: "gNHjNFL12",
            },
            {
              name: "Corolla",
              year: 2012,
              price: 40570,
              carNumber: "p2qEi",
              ownerId: "gNHjNFL12",
            },
          ],
        },
        {
          brand: "Ford",
          models: [
            {
              name: "Explorer",
              year: 2014,
              price: 127502,
              carNumber: "Ty1zN",
              ownerId: "gNHjNFL12",
            },
            {
              name: "F350",
              year: 2012,
              price: 54250,
              carNumber: "z03H2",
              ownerId: "gNHjNFL12",
            },
          ],
        },
        {
          brand: "Chevrolet",
          models: [
            {
              name: "Savannah",
              year: 2010,
              price: 36504,
              carNumber: "RXFZe",
              ownerId: "gNHjNFL12",
            },
            {
              name: "Malibu",
              year: 2009,
              price: 19585,
              carNumber: "K5IsM",
              ownerId: "gNHjNFL12",
            },
          ],
        },
      ],
    },
    {
      agencyName: "Car Werks",
      cash: 302502,
      credit: 150000,
      agencyId: "9KeaYbRLP",
      cars: [
        {
          brand: "bmw",
          models: [
            {
              name: "8",
              year: 2020,
              price: 942500,
              carNumber: "4IUMz",
              ownerId: "9KeaYbRLP",
            },
            {
              name: "X6",
              year: 2010,
              price: 129000,
              carNumber: "Vw0fV",
              ownerId: "9KeaYbRLP",
            },
            {
              name: "X3",
              year: 2019,
              price: 358100,
              carNumber: "ufN54",
              ownerId: "9KeaYbRLP",
            },
            {
              name: "3",
              year: 2020,
              price: 389100,
              carNumber: "F127X",
              ownerId: "9KeaYbRLP",
            },
            {
              name: "3",
              year: 2002,
              price: 18400,
              carNumber: "ueZUp",
              ownerId: "9KeaYbRLP",
            },
          ],
        },
        {
          brand: "toyota",
          models: [
            {
              name: "Prius",
              year: 2011,
              price: 38520,
              carNumber: "AZJZ4",
              ownerId: "9KeaYbRLP",
            },
            {
              name: "Land Cruiser",
              year: 2019,
              price: 290040,
              carNumber: "AZJZ4",
              ownerId: "9KeaYbRLP",
            },
            {
              name: "Hilux",
              year: 2020,
              price: 215700,
              carNumber: "xig8N",
              ownerId: "9KeaYbRLP",
            },
            {
              name: "Hilux",
              year: 2015,
              price: 178506,
              carNumber: "ghTiQ",
              ownerId: "9KeaYbRLP",
            },
            {
              name: "Corolla",
              year: 2002,
              price: 8504,
              carNumber: "Mvw8T",
              ownerId: "9KeaYbRLP",
            },
          ],
        },
        {
          brand: "Chevrolet",
          models: [
            {
              name: "Impala",
              year: 2005,
              price: 9320,
              carNumber: "BZpkt",
              ownerId: "9KeaYbRLP",
            },
            {
              name: "Malibu",
              year: 2002,
              price: 4502,
              carNumber: "KqKV_",
              ownerId: "9KeaYbRLP",
            },
          ],
        },
      ],
    },
    {
      agencyName: "Carsova",
      cash: 72450,
      credit: 50000,
      agencyId: "oqQmsZoUo",
      cars: [
        {
          brand: "bmw",
          models: [
            {
              name: "7",
              year: 1999,
              price: 24700,
              carNumber: "sZrjp",
              ownerId: "oqQmsZoUo",
            },
            {
              name: "3",
              year: 2008,
              price: 54000,
              carNumber: "da88K",
              ownerId: "oqQmsZoUo",
            },
          ],
        },
        {
          brand: "toyota",
          models: [
            {
              name: "Prius",
              year: 2019,
              price: 124050,
              carNumber: "ZfbqH",
              ownerId: "oqQmsZoUo",
            },
            {
              name: "Hilux",
              year: 1996,
              price: 11540,
              carNumber: "AZJZ4",
              ownerId: "oqQmsZoUo",
            },
          ],
        },
      ],
    },
  ],
  customers: [
    {
      name: "Lilah Goulding",
      id: "BGzHhjnE8",
      cars: [
        {
          name: "Corolla",
          year: 2013,
          price: 40570,
          carNumber: "16da1",
          ownerId: "BGzHhjnE8",
        },
      ],
      cash: 35000,
    },
    {
      name: "Ravi Murillo",
      id: "2RprZ1dbL",
      cars: [
        {
          name: "M5",
          year: 2019,
          price: 578054,
          carNumber: "WIh0U",
          ownerId: "2RprZ1dbL",
        },
        {
          name: "Spider",
          year: 2012,
          price: 81520,
          carNumber: "RLS4q",
          ownerId: "2RprZ1dbL",
        },
      ],
      cash: 278542,
    },
    {
      name: "Aleksander Carr",
      id: "pAuFtn_WA",
      cars: [
        {
          name: "Highlander",
          year: 2018,
          price: 214503,
          carNumber: "2WU_y",
          ownerId: "pAuFtn_WA",
        },
      ],
      cash: 125402,
    },
    {
      name: "Lana Edge",
      id: "cnTobUDy6",
      cars: [
        {
          name: "F250",
          year: 2020,
          price: 198500,
          carNumber: "Xxcy_",
          ownerId: "cnTobUDy6",
        },
        {
          name: "Hilux",
          year: 2005,
          price: 35005,
          carNumber: "VSCUj",
          ownerId: "cnTobUDy6",
        },
      ],
      cash: 7000,
    },
    {
      name: "Nikita Philip",
      id: "5x2tMcX4R",
      cars: [
        {
          name: "Impala",
          year: 2016,
          price: 65042,
          carNumber: "LKInp",
          ownerId: "5x2tMcX4R",
        },
      ],
      cash: 40541,
    },
    {
      name: "Bob Steel",
      id: "Wm6BkA1F0",
      cars: [],
      cash: 15732,
    },
    {
      name: "Will Reyes",
      id: "FQvNsEwLZ",
      cars: [
        { name: "X6", year: 2020, price: 966500, ownerId: "FQvNsEwLZ" },
        {
          name: "Land Cruiser",
          year: 2020,
          price: 336300,
          carNumber: "vaJvd",
          ownerId: "FQvNsEwLZ",
        },
        {
          name: "Romeo Julia",
          year: 2020,
          price: 275406,
          carNumber: "qLoYR",
          ownerId: "FQvNsEwLZ",
        },
        {
          name: "Explorer",
          year: 2020,
          price: 265200,
          carNumber: "tlGRq",
          ownerId: "FQvNsEwLZ",
        },
      ],
      cash: 1547242,
    },
  ],
  taxesAuthority: {
    totalTaxesPaid: 0,
    sumOfAllTransactions: 0,
    numberOfTransactions: 0,
  },
};
//1. Agency Operations:
// ! to find a car I used carNumber, because it is like id , will never be replied twice
// Search for a car agency by its name or ID.
function carAgency(name, id) {
  return carMarket.sellers.find(
    (agency) => agency.agencyId == id && agency.agencyName == name
  );
}

//Retrieve all agencies' names.
function carAgencyNames() {
  return carMarket.sellers.map((agency) => agency.agencyName);
}
// to use when add or remove car from database
const car = {
  brand: "bmw",
  models: {
    name: "3",
    year: 2015,
    price: 137000,
    carNumber: "AZJZ4",
    ownerId: "Plyq5M5AZ",
  },
};

//Add a new car to an agency's inventory.
function addNewCar(newCar, agencyId, agencyName) {
  return carMarket.sellers.find((agency) => {
    if (agency.agencyId == agencyId && agency.agencyName == agencyName) {
      agency.cars.find((car) => {
        if (car.brand == newCar.brand) {
          newCar.models.ownerId = agencyId;
          car.models.push(newCar.models);
        }
      });
    }
  });
}
// addNewCar(car , "Plyq5M5AZ" , "Best Deal")

//Remove a car from an agency's inventory.
function removeCar(carToBeRemoved, agencyId, agencyName) {
  return carMarket.sellers.find((agency) => {
    if ((agency.agencyId === agencyId) & (agency.agencyName === agencyName)) {
      agency.cars.find((car) => {
        if (car.brand == carToBeRemoved.brand) {
          let index = car.models.findIndex((model) => {
            return model.carNumber == carToBeRemoved.models.carNumber;
          });
          car.models.splice(index, 1);
          console.log(car);
        }
      });
    }
  });
}

// removeCar(car,"Plyq5M5AZ","Best Deal");

//Change the cash or credit of an agency
function changeCreditOrCash(paymentType, newPrice, agencyId, agencyName) {
  return carMarket.sellers.find((agency) => {
    if ((agency.agencyId === agencyId) & (agency.agencyName == agencyName)) {
      if (paymentType === "cash") {
        agency["cash"] = newPrice;
      } else if (paymentType === "credit") {
        agency["credit"] = newPrice;
      }
      console.log(agency);
    }
  });
}
// changeCreditOrCash("credit", 1000, "Plyq5M5AZ", "Best Deal");

//Update the price of a specific car in an agency (Method:  updateCarPrice ).
function updateCarPrice(newPrice, carNumber) {
  return carMarket.sellers.map((agency) => {
    agency.cars.map((car) => {
      car.models.map((model) => {
        if (carNumber == model.carNumber) {
          model["price"] = newPrice;
          console.log(model);
        }
      });
    });
  });
}
// updateCarPrice(7000, "LJTCs");

//Calculate and return the total revenue for a specific agency (Method:getTotalAgencyRevenue ).
function getTotalAgencyRevenue(agencyName, agencyId) {
  let sum = 0;
  carMarket.sellers.find((agency) => {
    if ((agency.agencyId === agencyId) & (agency.agencyName == agencyName)) {
      agency.cars.map((car) => {
        car.models.map((model) => {
          sum += model["price"];
        });
      });
    }
  });
  console.log(sum);
}
// getTotalAgencyRevenue("CarMax", "26_IPfHU1");

//Transfer a car from one agency to another (Method:  transferCarBetweenAgencies)
function transferCarBetweenAgencies(
  car,
  firstAgencyId,
  firstAgencyName,
  secondAgencyId,
  secondAgencyName
) {
  removeCar(car, firstAgencyId, firstAgencyName);
  addNewCar(car, secondAgencyId, secondAgencyName);
}

//2. Customer Operations:
//Search for a customer by their name or ID.
function searchCustomer(name, id) {
  return carMarket.customers.find(
    (customer) => customer.name === name && customer.id === id
  );
}
// console.log('searchCustomer("Lilah Goulding" , "BGzHhjnE8"): ', searchCustomer("Lilah Goulding" , "BGzHhjnE8"));

//Retrieve all customers' names.
function getCustomersNames() {
  return carMarket.customers.map((customer) => customer.name);
}
// console.log("customer names: " , getCustomersNames());

//Change the cash of a customer.
function changeCashOfCustomer(name, id, newCash) {
  return carMarket.customers.find((customer) => {
    if (customer.name === name && customer.id === id) {
      customer.cash = newCash;
      console.log(customer);
    }
  });
}
// changeCashOfCustomer("Ravi Murillo" , "2RprZ1dbL" , 300000 )

//Calculate the total value of all cars owned by a specific customer (Method: getCustomerTotalCarValue ).
function sumOfValue(name, id) {
  let sum = 0;
  carMarket.customers.find((customer) => {
    if (customer.name === name && customer.id === id) {
      customer.cars.map((car) => {
        sum += car.price;
      });
    }
  });
  console.log(sum);
}
// sumOfValue("Lana Edge", "cnTobUDy6");

//3. Car Operations:
//Retrieve all cars available for purchase.
function allCarsInAgency() {
  const cars = [];
  carMarket.sellers.map((agency) => {
    agency.cars.map((car) => {
      car.models.map((model) => {
        cars.push(model);
      });
    });
  });
  return cars;
}
function allCarsWithCustomers() {
  const cars = [];
  carMarket.customers.map((customer) => {
    customer.cars.map((car) => {
      cars.push(car);
    });
  });
  return cars;
}

// ! ???
function getAllCarsForSale() {
  const AvailableCars = allCarsInAgency();
  const allCarsThatTaken = allCarsWithCustomers();
  allCarsThatTaken.map((actt) => {
    let index = AvailableCars.findIndex(
      (car) => actt.carNumber == car.carNumber
    );
    AvailableCars.splice(index, 1);
  });
  return AvailableCars;
}
// console.log(getAllCarsForSale());

//Search for cars based on certain criteria. The search parameters should include the production year, price, and optionally, the brand of the car.
function searchCriteriaCar(year, price) {
  return allCarsWithCustomers().filter(
    (car) => car.year == year && car.price == price
  );
}
// console.log(searchCriteriaCar(2019, 578054));

//Return the most expensive car available for sale (Method:  getMostExpensiveCar ).
function getMostExpensiveCar() {
  return getAllCarsForSale().reduce((acc, currentCar) => {
    return currentCar.price > acc.price ? currentCar : acc;
  });
}
// console.log(getMostExpensiveCar());

//Return the cheapest car available for sale (Method:  getCheapestCar ).
function getCheapestCar() {
  return getAllCarsForSale().reduce((acc, currentCar) => {
    return currentCar.price < acc.price ? currentCar : acc;
  });
}
// console.log(getCheapestCar());

//4. Car Purchase Operations:
//Implement a  sellCar  function that sells a car to a specific customer.
//This function should:
function sellCar(newCar, customerId, customerName) {
  //Check the availability of the car at the agency.
  const available = getAllCarsForSale().find(
    (car) => newCar.models.carNumber === car.carNumber
  );
  if (available) {
    carMarket.customers.find((customer) => {
      if (customer.id === customerId && customer.name === customerName) {
        //Verify if the customer has enough cash to purchase the car.
        if (customer.cash >= newCar.models.price) {
          carMarket.sellers.find((seller) => {
            if (seller.agencyId == newCar.models.ownerId) {
              //Update the cash and credit for both the agency
              changeCreditOrCash(
                "cash",
                seller.cash + newCar.models.price,
                seller.agencyId,
                seller.agencyName
              );
              changeCreditOrCash(
                "credit",
                seller.credit + newCar.models.price,
                seller.agencyId,
                seller.agencyName
              );
            }
          });
          newCar.models.ownerId = customerId;
          customer.cars.push(newCar.models);
          //  update the cash of the customer
          customer.cash -= newCar.models.price;
          console.log(customer);
          //Update the tax authority's records.
          carMarket.taxesAuthority.totalTaxesPaid += newCar.models.price * 0.17;
          carMarket.taxesAuthority.sumOfAllTransactions += newCar.models.price;
          carMarket.taxesAuthority.numberOfTransactions++;
          console.log(carMarket.taxesAuthority);
        } else console.log("customer has no enough money");
      }
    });
  }
}
// sellCar(car, "5x2tMcX4R", "Nikita Philip");
// sellCar(car, "FQvNsEwLZ", "Will Reyes");

//Calculate and return the total revenue of the entire market (Method:getTotalMarketRevenue ).
function getTotalMarketRevenue() {
  let sumOfSellers = 0;
  let sumOfCustomers = 0;
  let sumOfTax = 0;
  carMarket.sellers.forEach((seller) => {
    sumOfSellers += seller.cash;
  });
  carMarket.customers.forEach((customer) => {
    sumOfCustomers += customer.cash;
  });
  sumOfTax = carMarket.taxesAuthority.sumOfAllTransactions;
  return Number(sumOfCustomers) + Number(sumOfSellers) + Number(sumOfTax);
}
// console.log("get total Market Revenue: ", getTotalMarketRevenue());
